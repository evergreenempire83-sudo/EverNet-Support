<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EverNet Support System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #dbeafe;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --radius: 8px;
            --radius-lg: 12px;
        }

        [data-theme="dark"] {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --primary-light: #1e3a8a;
            --secondary: #94a3b8;
            --dark: #0f172a;
            --light: #1e293b;
            --gray-50: #1e293b;
            --gray-100: #334155;
            --gray-200: #475569;
            --gray-300: #64748b;
            --gray-400: #94a3b8;
            --gray-500: #cbd5e1;
            --gray-600: #e2e8f0;
            --gray-700: #f1f5f9;
            --gray-800: #f8fafc;
            --gray-900: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: var(--light);
            color: var(--gray-800);
            line-height: 1.6;
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        /* Header */
        .header {
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            padding: 1rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--dark);
        }

        .brand-logo {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--info));
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Main Layout */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
            display: grid;
            grid-template-columns: 300px 1fr 400px;
            gap: 1.5rem;
            min-height: calc(100vh - 80px);
        }

        /* Sidebar */
        .sidebar {
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            padding: 1.5rem;
            height: fit-content;
            position: sticky;
            top: 100px;
        }

        .user-card {
            background: white;
            border-radius: var(--radius);
            padding: 1.25rem;
            text-align: center;
            margin-bottom: 1.5rem;
            border: 1px solid var(--gray-200);
        }

        .user-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--info));
            margin: 0 auto 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.25rem;
        }

        .user-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .user-role {
            color: var(--gray-600);
            font-size: 0.875rem;
            background: var(--gray-100);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            display: inline-block;
        }

        .stats-grid {
            display: grid;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 1rem;
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--gray-600);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* Quick Actions */
        .quick-actions {
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-buttons {
            display: grid;
            gap: 0.5rem;
        }

        .btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: var(--radius);
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--gray-300);
            color: var(--gray-700);
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        /* Chat List */
        .chat-list-container {
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            overflow: hidden;
        }

        .chat-list-header {
            background: white;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
        }

        .chat-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .chat-item {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .chat-item:hover {
            background: var(--primary-light);
        }

        .chat-item.active {
            background: var(--primary-light);
            border-left: 4px solid var(--primary);
        }

        .chat-item.unread {
            background: #fef7ed;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .chat-user {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.875rem;
        }

        .chat-time {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .chat-preview {
            font-size: 0.8125rem;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .chat-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: var(--success);
            color: white;
        }

        .status-pending {
            background: var(--warning);
            color: white;
        }

        .status-resolved {
            background: var(--gray-300);
            color: var(--gray-700);
        }

        .unread-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary);
        }

        /* Chat Area */
        .chat-area {
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            height: 600px;
        }

        .chat-header {
            background: white;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-avatar-sm {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--info));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .user-details h3 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.125rem;
        }

        .user-details p {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .chat-actions {
            display: flex;
            gap: 0.5rem;
        }

        .messages-container {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .message {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            line-height: 1.5;
            position: relative;
            animation: messageAppear 0.3s ease;
        }

        .message.support {
            align-self: flex-start;
            background: white;
            border: 1px solid var(--gray-200);
            border-bottom-left-radius: 4px;
        }

        .message.user {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.system {
            align-self: center;
            background: var(--gray-200);
            color: var(--gray-600);
            font-style: italic;
            max-width: 90%;
            text-align: center;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 0.25rem;
            text-align: right;
        }

        .chat-input-area {
            padding: 1.25rem 1.5rem;
            border-top: 1px solid var(--gray-200);
            background: white;
        }

        .message-form {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 0.875rem;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            transition: all 0.3s ease;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .send-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        /* Analytics Panel */
        .analytics-panel {
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            padding: 1.5rem;
            height: fit-content;
            position: sticky;
            top: 100px;
        }

        .metric-card {
            background: white;
            border-radius: var(--radius);
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid var(--gray-200);
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--gray-600);
            text-transform: uppercase;
            font-weight: 600;
        }

        .progress-bar {
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Theme Toggle */
        .theme-toggle {
            background: none;
            border: none;
            color: var(--gray-600);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--radius);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--gray-200);
            color: var(--gray-800);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 280px 1fr;
            }
            .analytics-panel {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                padding: 1rem;
                gap: 1rem;
            }
            
            .sidebar {
                position: static;
                order: 2;
            }
            
            .chat-list-container {
                order: 1;
            }
            
            .chat-area {
                order: 3;
                height: 500px;
            }
            
            .header-content {
                flex-wrap: wrap;
            }
            
            .brand {
                font-size: 1.125rem;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 1rem;
            }
            
            .main-container {
                padding: 0.75rem;
            }
            
            .chat-header {
                padding: 1rem;
            }
            
            .messages-container {
                padding: 1rem;
            }
            
            .message {
                max-width: 85%;
                font-size: 0.8125rem;
            }
        }

        /* Animations */
        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-xs {
            font-size: 0.75rem;
        }

        .font-semibold {
            font-weight: 600;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mt-2 {
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="brand">
                <div class="brand-logo">E</div>
                <span>EverNet Support</span>
            </div>
            <div class="header-actions">
                <button class="theme-toggle" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="btn btn-outline" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Sign Out
                </button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="user-card">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-name" id="userName">Loading...</div>
                <div class="user-role">Support Agent</div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalConversations">0</div>
                    <div class="stat-label">Total Conversations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeConversations">0</div>
                    <div class="stat-label">Active Now</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="unreadMessages">0</div>
                    <div class="stat-label">Unread Messages</div>
                </div>
            </div>

            <div class="quick-actions">
                <h3 class="section-title">Quick Actions</h3>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="setupSupportSystem()">
                        <i class="fas fa-cog"></i>
                        Setup System
                    </button>
                    <button class="btn btn-outline" onclick="debugFirestore()">
                        <i class="fas fa-bug"></i>
                        Debug Firestore
                    </button>
                    <button class="btn btn-outline" onclick="exportConversations()">
                        <i class="fas fa-download"></i>
                        Export Data
                    </button>
                </div>
            </div>

            <div class="quick-actions">
                <h3 class="section-title">Filters</h3>
                <div class="action-buttons">
                    <button class="btn btn-outline active" onclick="setFilter('all')">
                        All Conversations
                        <span class="filter-badge" id="countAll">0</span>
                    </button>
                    <button class="btn btn-outline" onclick="setFilter('active')">
                        Active
                        <span class="filter-badge" id="countActive">0</span>
                    </button>
                    <button class="btn btn-outline" onclick="setFilter('unread')">
                        Unread
                        <span class="filter-badge" id="countUnread">0</span>
                    </button>
                    <button class="btn btn-outline" onclick="setFilter('resolved')">
                        Resolved
                        <span class="filter-badge" id="countResolved">0</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Chat List & Area -->
        <main class="chat-list-container">
            <div class="chat-list-header">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" placeholder="Search conversations...">
                </div>
            </div>
            <div class="chat-list" id="chatsContainer">
                <!-- Conversations will be loaded here -->
            </div>
        </main>

        <!-- Chat Area -->
        <section class="chat-area hidden" id="chatArea">
            <div class="chat-header">
                <div class="user-info">
                    <div class="user-avatar-sm" id="currentUserAvatar">U</div>
                    <div class="user-details">
                        <h3 id="currentUserName">Select a conversation</h3>
                        <p id="currentUserEmail">Click on a conversation to start chatting</p>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="btn btn-success" onclick="markAsResolved()">
                        <i class="fas fa-check"></i>
                        Resolve
                    </button>
                    <button class="btn btn-outline" onclick="refreshChat()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn btn-danger" onclick="deleteConversation()" id="deleteConversationBtn">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <div class="messages-container" id="messagesContainer">
                <div class="text-center" style="padding: 2rem; color: var(--gray-500);">
                    <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                    <h3>No conversation selected</h3>
                    <p>Select a conversation from the list to view messages</p>
                </div>
            </div>

            <div class="chat-input-area">
                <form class="message-form" id="messageForm">
                    <textarea 
                        class="message-input" 
                        id="messageInput" 
                        placeholder="Type your response..." 
                        rows="1"
                        disabled
                    ></textarea>
                    <button type="submit" class="send-btn" id="sendBtn" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </section>

        <!-- Analytics Panel -->
        <aside class="analytics-panel">
            <h3 class="section-title">Live Analytics</h3>
            
            <div class="metric-card">
                <div class="metric-value" id="avgResponseTime">0s</div>
                <div class="metric-label">Avg Response Time</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 65%"></div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-value" id="satisfactionRate">0%</div>
                <div class="metric-label">Satisfaction Rate</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 85%"></div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-value" id="resolutionRate">0%</div>
                <div class="metric-label">First Contact Resolution</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 78%"></div>
                </div>
            </div>

            <div class="quick-actions mt-2">
                <h3 class="section-title">AI Suggestions</h3>
                <div class="action-buttons">
                    <button class="btn btn-outline" onclick="generateSmartReply()">
                        <i class="fas fa-robot"></i>
                        Smart Reply
                    </button>
                    <button class="btn btn-outline" onclick="analyzeSentiment()">
                        <i class="fas fa-chart-line"></i>
                        Sentiment Analysis
                    </button>
                </div>
            </div>
        </aside>
    </div>

    <!-- Notification Sound -->
    <audio id="notificationSound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/286/286-preview.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAuSEqhLenwrEz-qrIn1drjAugy1YSkDlI",
            authDomain: "creators-portal-428c5.firebaseapp.com",
            projectId: "creators-portal-428c5",
            storageBucket: "creators-portal-428c5.firebasestorage.app",
            messagingSenderId: "499280036303",
            appId: "1:499280036303:web:b4d80d3b7fe1291381d2ba",
            measurementId: "G-CYWGD80FS5"
        };

        // Initialize Firebase
        let app, auth, db;
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
        } catch (error) {
            app = firebase.app();
            auth = firebase.auth();
            db = firebase.firestore();
        }

        // Global Variables
        let currentFilter = 'all';
        let currentConversation = null;
        let conversationsListener = null;
        let messagesListener = null;
        let currentUser = null;
        let lastMessageCount = 0;
        let allConversations = [];

        // Enhanced Auto Greeting System
        function updateGreeting() {
            const hour = new Date().getHours();
            let greeting = "Good ";
            
            if (hour < 12) {
                greeting += "morning";
            } else if (hour < 18) {
                greeting += "afternoon";
            } else {
                greeting += "evening";
            }
            
            // Update user card with greeting
            const userName = document.getElementById('userName');
            if (userName && currentUser) {
                userName.textContent = `${greeting}, ${currentUser.email.split('@')[0]}!`;
            }
        }

        // Theme Management
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            const themeIcon = document.querySelector('.theme-toggle i');
            themeIcon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            const themeIcon = document.querySelector('.theme-toggle i');
            themeIcon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        // Enhanced Support System Setup
        async function setupSupportSystem() {
            const user = auth.currentUser;
            if (!user) {
                alert("Please login first");
                return;
            }
            
            try {
                // Add current user as support admin with enhanced data
                await db.collection('supportTeam').doc(user.uid).set({
                    email: user.email,
                    name: user.displayName || "Support Admin",
                    role: "admin",
                    online: true,
                    active: true,
                    permissions: ['read', 'write', 'delete', 'admin'],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                    stats: {
                        conversationsHandled: 0,
                        avgResponseTime: 0,
                        satisfactionScore: 0
                    }
                });
                
                // Initialize system settings
                await db.collection('supportSettings').doc('system').set({
                    autoGreeting: true,
                    smartReplies: true,
                    satisfactionSurveys: true,
                    workingHours: {
                        start: '09:00',
                        end: '18:00',
                        timezone: 'UTC'
                    },
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log("âœ… Enhanced support system setup complete!");
                alert("Support system initialized with advanced features!");
                
            } catch (error) {
                console.error("Setup error:", error);
                alert("Setup failed: " + error.message);
            }
        }

        // Enhanced Debug Function
        async function debugFirestore() {
            const user = auth.currentUser;
            console.log("=== ENHANCED SUPPORT SYSTEM DEBUG ===");
            console.log("Current User:", user?.uid, user?.email);
            
            try {
                // Test all collections
                const collections = ['supportTeam', 'supportChats', 'supportConversations', 'supportSettings', 'supportAnalytics'];
                
                for (const collection of collections) {
                    const snapshot = await db.collection(collection).get();
                    console.log(`${collection}: ${snapshot.size} documents`);
                    snapshot.forEach(doc => {
                        console.log(`  ${doc.id}:`, doc.data());
                    });
                }
                
            } catch (error) {
                console.error("âŒ Debug FAILED:", error);
            }
        }

        // Initialize Enhanced Support Portal
        function initializeSupportPortal() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const hasAccess = await checkSupportAccess(user);
                    
                    if (hasAccess) {
                        currentUser = user;
                        document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();
                        document.getElementById('userName').textContent = user.email.split('@')[0];
                        
                        // Initialize all systems
                        loadTheme();
                        updateGreeting();
                        initializePortalFunctionality();
                        startAnalytics();
                        
                        // Update greeting every minute
                        setInterval(updateGreeting, 60000);
                    } else {
                        alert("Access Denied: You don't have support team permissions");
                        logout();
                    }
                } else {
                    redirectToLogin();
                }
            });
        }

        // Enhanced Access Control
        async function checkSupportAccess(user) {
            try {
                const supportDoc = await db.collection('supportTeam').doc(user.uid).get();
                if (supportDoc.exists) {
                    // Update last active timestamp
                    await db.collection('supportTeam').doc(user.uid).update({
                        lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                        online: true
                    });
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error checking support access:', error);
                return false;
            }
        }

        // Enhanced Portal Initialization
        function initializePortalFunctionality() {
            console.log('ðŸš€ Initializing enhanced support portal...');
            
            // Load conversations
            loadConversations();

            // Setup message form
            document.getElementById('messageForm').addEventListener('submit', sendMessage);

            // Auto-resize textarea
            document.getElementById('messageInput').addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            // Search functionality
            document.getElementById('searchInput').addEventListener('input', filterConversations);

            // Setup real-time analytics
            setupRealTimeAnalytics();
        }

        // Enhanced Conversations Loader
        function loadConversations() {
            const chatsContainer = document.getElementById('chatsContainer');
            
            console.log("ðŸ”„ Loading enhanced conversations...");
            
            conversationsListener = db.collection('supportConversations')
                .orderBy('lastActivity', 'desc')
                .onSnapshot(snapshot => {
                    console.log("ðŸ“¨ Enhanced conversations snapshot:", snapshot.size);
                    
                    allConversations = [];
                    let stats = {
                        total: 0,
                        active: 0,
                        unread: 0,
                        resolved: 0
                    };

                    snapshot.forEach(doc => {
                        const conversation = {
                            id: doc.id,
                            ...doc.data()
                        };
                        allConversations.push(conversation);
                        
                        stats.total++;
                        if (conversation.status === 'active') stats.active++;
                        if (conversation.status === 'resolved') stats.resolved++;
                        // Enhanced unread logic can be added here
                    });

                    stats.unread = stats.active; // Simplified for now

                    // Update stats in real-time
                    updateStats(stats);
                    renderConversations(allConversations);
                    
                }, error => {
                    console.error('Error loading conversations:', error);
                    showError('Failed to load conversations: ' + error.message);
                });
        }

        // Enhanced Stats Updater
        function updateStats(stats) {
            document.getElementById('totalConversations').textContent = stats.total;
            document.getElementById('activeConversations').textContent = stats.active;
            document.getElementById('unreadMessages').textContent = stats.unread;
            
            document.getElementById('countAll').textContent = stats.total;
            document.getElementById('countActive').textContent = stats.active;
            document.getElementById('countUnread').textContent = stats.unread;
            document.getElementById('countResolved').textContent = stats.resolved;

            // Update analytics panel
            updateAnalyticsPanel(stats);
        }

        // Enhanced Conversations Renderer
        function renderConversations(conversations) {
            const chatsContainer = document.getElementById('chatsContainer');
            
            if (conversations.length === 0) {
                chatsContainer.innerHTML = `
                    <div style="padding: 3rem 1rem; text-align: center; color: var(--gray-500);">
                        <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <h3>No conversations yet</h3>
                        <p>When users start conversations, they'll appear here</p>
                    </div>
                `;
                return;
            }

            let html = '';
            conversations.forEach(conversation => {
                const time = conversation.lastActivity ? 
                    formatTime(conversation.lastActivity.toDate()) : 'Just now';
                
                const isActive = conversation.id === currentConversation?.id;
                const isUnread = conversation.status === 'active'; // Enhanced logic needed
                
                html += `
                    <div class="chat-item ${isActive ? 'active' : ''} ${isUnread ? 'unread' : ''}" 
                         onclick="selectConversation('${conversation.id}')">
                        <div class="chat-header">
                            <div class="chat-user">${conversation.userEmail}</div>
                            <div class="chat-time">${time}</div>
                        </div>
                        <div class="chat-preview">
                            ${conversation.lastMessage || 'No messages yet'}
                        </div>
                        <div class="chat-meta">
                            <span class="status-badge status-${conversation.status}">${conversation.status}</span>
                            ${isUnread ? '<div class="unread-indicator"></div>' : ''}
                        </div>
                    </div>
                `;
            });

            chatsContainer.innerHTML = html;
        }

        // Enhanced Conversation Selection
        async function selectConversation(conversationId) {
            console.log("ðŸŽ¯ Selecting conversation:", conversationId);
            
            if (messagesListener) {
                messagesListener();
            }

            try {
                const doc = await db.collection('supportConversations').doc(conversationId).get();
                if (doc.exists) {
                    currentConversation = { id: doc.id, ...doc.data() };
                    
                    // Update UI
                    updateChatHeader(currentConversation);
                    
                    // Enable messaging
                    document.getElementById('messageInput').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                    
                    // Show chat area
                    document.getElementById('chatArea').classList.remove('hidden');
                    
                    // Load messages
                    loadMessages(conversationId);
                    
                    // Update conversation as read
                    markConversationAsRead(conversationId);
                }
            } catch (error) {
                console.error('Error selecting conversation:', error);
                showError('Failed to load conversation');
            }
        }

        // Enhanced Chat Header Update
        function updateChatHeader(conversation) {
            document.getElementById('currentUserName').textContent = conversation.userEmail;
            document.getElementById('currentUserEmail').textContent = conversation.userEmail;
            document.getElementById('currentUserAvatar').textContent = conversation.userEmail.charAt(0).toUpperCase();
        }

        // Enhanced Messages Loader
        function loadMessages(conversationId) {
            const messagesContainer = document.getElementById('messagesContainer');
            
            messagesListener = db.collection('supportChats')
                .where('conversationId', '==', conversationId)
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    console.log("ðŸ“¨ Messages loaded:", snapshot.size);
                    
                    messagesContainer.innerHTML = '';
                    
                    if (snapshot.empty) {
                        messagesContainer.innerHTML = `
                            <div style="text-align: center; padding: 2rem; color: var(--gray-500);">
                                <i class="fas fa-comment-alt" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                <p>No messages yet in this conversation</p>
                                <p class="text-sm">Start the conversation by sending a message</p>
                            </div>
                        `;
                        lastMessageCount = 0;
                        return;
                    }
                    
                    let messageCount = 0;
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        message.id = doc.id;
                        displayMessage(message);
                        messageCount++;
                    });
                    
                    // Notification for new messages
                    if (snapshot.size > lastMessageCount && lastMessageCount > 0) {
                        playNotificationSound();
                        showNotification('New message received');
                    }
                    
                    lastMessageCount = snapshot.size;
                    
                    // Auto-scroll to bottom
                    setTimeout(() => {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }, 100);
                    
                }, error => {
                    console.error('Error loading messages:', error);
                    showError('Failed to load messages');
                });
        }

        // Enhanced Message Display
        function displayMessage(message) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageElement = document.createElement('div');
            
            messageElement.className = `message ${message.senderType}`;
            
            const time = message.timestamp ? 
                formatTime(message.timestamp.toDate()) : 'Just now';
            
            messageElement.innerHTML = `
                <div>${message.message}</div>
                <div class="message-time">${time}</div>
            `;
            
            messagesContainer.appendChild(messageElement);
        }

        // Enhanced Message Sender
        async function sendMessage(e) {
            e.preventDefault();
            
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !currentConversation) return;
            
            try {
                const messageData = {
                    conversationId: currentConversation.id,
                    userId: currentConversation.userId,
                    userEmail: currentConversation.userEmail,
                    message: message,
                    senderType: 'support',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    read: true,
                    agentId: currentUser.uid
                };

                await db.collection('supportChats').add(messageData);

                // Update conversation
                await db.collection('supportConversations').doc(currentConversation.id).update({
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'active',
                    assignedAgent: currentUser.uid,
                    lastMessage: message.substring(0, 100) + (message.length > 100 ? '...' : '')
                });

                // Clear input
                messageInput.value = '';
                messageInput.style.height = 'auto';
                
                // Log activity
                logSupportActivity('message_sent', {
                    conversationId: currentConversation.id,
                    messageLength: message.length
                });
                
            } catch (error) {
                console.error('Error sending message:', error);
                showError('Failed to send message');
            }
        }

        // Enhanced Conversation Management
        async function markAsResolved() {
            if (!currentConversation) return;
            
            if (confirm('Mark this conversation as resolved?')) {
                try {
                    await db.collection('supportConversations').doc(currentConversation.id).update({
                        status: 'resolved',
                        resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        resolvedBy: currentUser.uid
                    });
                    
                    // Add system message
                    await db.collection('supportChats').add({
                        conversationId: currentConversation.id,
                        message: `âœ… Conversation marked as resolved by support agent.`,
                        senderType: 'system',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showNotification('Conversation marked as resolved');
                    
                    // Log activity
                    logSupportActivity('conversation_resolved', {
                        conversationId: currentConversation.id
                    });
                    
                } catch (error) {
                    console.error('Error resolving conversation:', error);
                    showError('Failed to resolve conversation');
                }
            }
        }

        async function deleteConversation() {
            if (!currentConversation) return;
            
            if (confirm('Are you sure you want to delete this conversation? This action cannot be undone.')) {
                try {
                    // Delete all messages
                    const messagesSnapshot = await db.collection('supportChats')
                        .where('conversationId', '==', currentConversation.id)
                        .get();
                    
                    const batch = db.batch();
                    messagesSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    await batch.commit();
                    
                    // Delete conversation
                    await db.collection('supportConversations').doc(currentConversation.id).delete();
                    
                    // Reset UI
                    document.getElementById('chatArea').classList.add('hidden');
                    currentConversation = null;
                    
                    showNotification('Conversation deleted successfully');
                    
                } catch (error) {
                    console.error('Error deleting conversation:', error);
                    showError('Failed to delete conversation');
                }
            }
        }

        // Enhanced Analytics
        function setupRealTimeAnalytics() {
            // Update analytics every 30 seconds
            setInterval(updateLiveAnalytics, 30000);
            updateLiveAnalytics();
        }

        async function updateLiveAnalytics() {
            try {
                // Calculate average response time
                const responseTimes = await calculateResponseTimes();
                document.getElementById('avgResponseTime').textContent = 
                    responseTimes > 0 ? `${Math.round(responseTimes / 60)}m` : '0s';
                
                // Update other metrics
                document.getElementById('satisfactionRate').textContent = '92%';
                document.getElementById('resolutionRate').textContent = '78%';
                
            } catch (error) {
                console.error('Error updating analytics:', error);
            }
        }

        async function calculateResponseTimes() {
            // Simplified implementation - enhance with real data
            return 120; // 2 minutes average
        }

        // Utility Functions
        function formatTime(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function formatDate(date) {
            return date.toLocaleDateString();
        }

        function playNotificationSound() {
            const audio = document.getElementById('notificationSound');
            audio.currentTime = 0;
            audio.play().catch(e => console.log('Audio play failed:', e));
        }

        function showNotification(message) {
            // Simple notification - enhance with toast library
            console.log("ðŸ”” " + message);
        }

        function showError(message) {
            alert("Error: " + message);
        }

        function setFilter(filter) {
            currentFilter = filter;
            
            // Update active filter buttons
            document.querySelectorAll('.action-buttons .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Filter conversations
            filterConversations();
        }

        function filterConversations() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            let filtered = allConversations;
            
            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(conv => 
                    conv.userEmail.toLowerCase().includes(searchTerm) ||
                    (conv.lastMessage && conv.lastMessage.toLowerCase().includes(searchTerm))
                );
            }
            
            // Apply status filter
            if (currentFilter !== 'all') {
                filtered = filtered.filter(conv => conv.status === currentFilter);
            }
            
            renderConversations(filtered);
        }

        function markConversationAsRead(conversationId) {
            // Implement read status tracking
            console.log("Marking conversation as read:", conversationId);
        }

        function refreshChat() {
            if (currentConversation) {
                loadMessages(currentConversation.id);
            }
        }

        function logSupportActivity(action, data) {
            // Log support activities for analytics
            console.log("ðŸ“Š Activity:", action, data);
        }

        // AI Features (Placeholders)
        function generateSmartReply() {
            showNotification("Smart reply feature coming soon!");
        }

        function analyzeSentiment() {
            showNotification("Sentiment analysis feature coming soon!");
        }

        function exportConversations() {
            showNotification("Export feature coming soon!");
        }

        function updateAnalyticsPanel(stats) {
            // Enhanced analytics updates
            console.log("Updating analytics with:", stats);
        }

        function startAnalytics() {
            // Start real-time analytics tracking
            console.log("Starting analytics...");
        }

        // Navigation
        function redirectToLogin() {
            window.location.href = 'support-login.html';
        }

        function logout() {
            if (currentUser) {
                // Update user status
                db.collection('supportTeam').doc(currentUser.uid).update({
                    online: false,
                    lastActive: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            auth.signOut().then(() => {
                redirectToLogin();
            }).catch((error) => {
                console.error('Logout error:', error);
                redirectToLogin();
            });
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeSupportPortal();
        });

        // Cleanup
        window.addEventListener('beforeunload', function() {
            if (conversationsListener) conversationsListener();
            if (messagesListener) messagesListener();
            
            if (currentUser) {
                db.collection('supportTeam').doc(currentUser.uid).update({
                    online: false,
                    lastActive: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        });
    </script>
</body>
</html>